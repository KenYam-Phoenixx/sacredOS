<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
  <h1>OS Tests</h1>
  <p>This program is for Sacred OS software development purposes.
    <strong>Note: Running tests will create a bunch of folders and files.</strong>
  </p>
  <br />
  <button onclick="runTests()">Start Tests</button>
  <script>
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    let diskBackup;
    let awaitingAF = true;

    function printPassed(message) {
      console.log(`%cPassed: ${message}`, "color:green");
    }

    function printFailed(message) {
      console.log(`%cFailed: ${message}`, "color:red");
    }

    async function __createFolderAtRoot() {
      const message = "Can create a folder named 'test' in root directory.";
      window.top.postMessage("MK:D[test]", "*");

      while (awaitingAF) {
        await sleep(100);
      }

      if (diskBackup && diskBackup["test"]) {
        printPassed(message);
        return true;
      } else {
        printFailed(message);
        return false;
      }
    }

    async function __createFolderTwoLevelsDeep() {
      awaitingAF = true;
      const message = "Can create a folder named '2' in /test directory.";
      window.top.postMessage("MK:D[test/2]", "*");

      while (awaitingAF) {
        await sleep(100);
      }

      if (diskBackup && diskBackup["test"]["2"]) {
        printPassed(message);
        return true;
      } else {
        printFailed(message);
        return false;
      }
    }

    async function __createFolderThreeLevelsDeep() {
      awaitingAF = true;
      const message = "Can create a folder named '3' in /test/2 directory.";
      window.top.postMessage("MK:D[test/2/3]", "*");

      while (awaitingAF) {
        await sleep(100);
      }

      if (diskBackup && diskBackup["test"]["2"]["3"]) {
        printPassed(message);
        return true;
      } else {
        printFailed(message);
        return false;
      }
    }

    async function __createFileAtRoot() {
      awaitingAF = true;
      const message = "Can create a file named 'test.txt' in root directory.";
      window.top.postMessage("MK:F[test.txt]", "*");

      while (awaitingAF) {
        await sleep(100);
      }

      if (diskBackup && "test.txt" in diskBackup) {
        printPassed(message);
        return true;
      } else {
        printFailed(message);
        return false;
      }
    }

    async function __createFileTwoLevelsDeep() {
      awaitingAF = true;
      const message = "Can create a file named '2.txt' in /test/ directory.";
      window.top.postMessage("MK:F[test/2.txt]", "*");

      while (awaitingAF) {
        await sleep(100);
      }

      if (diskBackup && "2.txt" in diskBackup["test"]) {
        printPassed(message);
        return true;
      } else {
        printFailed(message);
        return false;
      }
    }

    // Do NOT rearrange order of tests.
    const testCalls = [
      __createFolderAtRoot,
      __createFolderTwoLevelsDeep,
      __createFolderThreeLevelsDeep,
      __createFileAtRoot, 
      __createFileTwoLevelsDeep];

    async function runTests() {
      let testPoints = testCalls.length;
      for (const [testNumber, test] of testCalls.entries()) {
        // if Test fails
        if (!await test()) {
          testPoints--;
        }
      }
      console.log(`%cPassed ${testPoints} out of ${testCalls.length} tests.`, "color:blue");
    }

    window.addEventListener("message", function (e) {
      if (e.data.startsWith("AF:")) {
        const jsonString = e.data.substring(3);
        try {
          diskBackup = JSON.parse(jsonString);
        } catch (error) {
          console.error("Error parsing JSON data:", error);
        }
        awaitingAF = false;
        return;
      } else if (e.data.startsWith("SS:")) {
        const stylesheet = e.data.substring(3);
        try {
          const styleElement = document.createElement('style');
          styleElement.type = 'text/css';
          styleElement.innerText = stylesheet;
          document.head.appendChild(styleElement);
        } catch (error) {
          console.error("Error requesting stylesheet:", error);
        }
        return;
      }
    });
  </script>
</body>

</html>